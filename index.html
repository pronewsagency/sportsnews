<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>أخبار كرة القدم</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom, #192842, #192842);
      color: #333;
      padding-bottom: 60px;
    }
    .top-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap; 
    }
    .btn-group {
      background: linear-gradient(to right,#100f8a 50%, #09034a);
      border-radius: 0.375rem; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden; 
    }
    .btn-group .btn {
      background: transparent;
      color: #fff;
      font-weight: bold;
      border-color: rgba(255, 255, 255, 0.3) !important; 
      border-left: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    .btn-group .btn:first-child {
      border-left: none; 
    }
    .btn-group .btn:hover {
      background: rgba(255, 255, 255, 0.2); 
      transform: none; 
      box-shadow: none;
    }
    .btn-group .btn.active {
      background: linear-gradient(to bottom, #103f8a 50%, #09069a); 
    }
    .news-container { max-width: 900px; margin: 20px auto; }
    .card {
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      border: none;
      background: linear-gradient(to bottom, #100f8a 50%, #09034a);
      color: #fff;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    .card-img-top { height: 200px; object-fit: cover; }
    .card-title { font-weight: bold; }
    .card-text {
      color: #fff !important; /* هذا هو الجزء المضاف */
    }
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 70vh;
    }
    .spinner-border {
      color: #fff;
      border-right-color: transparent !important;
      border-top-color: transparent !important;
      animation: spinner-spin 0.75s linear infinite;
    }
    @keyframes spinner-spin {
      to { transform: rotate(360deg); }
    }
    /* Placeholder for the image */
    .image-placeholder {
      position: relative;
      height: 200px;
      background: linear-gradient(to bottom, #100f8a 50%, #09034a);
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 2rem;
      font-weight: bold;
      border-top-left-radius: inherit;
      border-top-right-radius: inherit;
    }
    .card img.card-img-top {
      display: none; 
    }
    .card img.card-img-top.loaded {
      display: block; 
    }
    .error-message {
      text-align: center;
      margin-top: 50px;
      font-size: 1.2rem;
      color: #dc3545; 
    }
    .retry-button {
      background: linear-gradient(to right, #6c757d, #adb5bd); 
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      margin-top: 20px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .retry-button:hover {
      background: linear-gradient(to right, #adb5bd, #6c757d);
    }
    /* تنسيق الشريط السفلي */
    .footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: linear-gradient(to right, #192842);
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 8px 0;
        z-index: 1000;
    }
    .footer-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        color: #fff;
        text-decoration: none;
        font-size: 0.8rem;
        transition: transform 0.2s ease;
    }
    .footer-btn:hover {
        transform: scale(1.1);
    }
    .footer-btn img {
        width: 20px; 
        height: 20px; 
        margin-bottom: 4px;
    }
    .footer-btn .fas {
        font-size: 20px;
        margin-bottom: 4px;
    }
    /* شريط البحث */
    .search-bar-container {
      display: none;
      position: sticky;
      top: 0;
      background: #192842; /* الخلفية الخارجية بيضاء */
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 999;
      border-radius: 0.375rem;
      margin: 10px auto;
      max-width: 900px;
    }
    .search-bar-container.active {
      display: flex;
    }
    .search-bar-container input {
      flex-grow: 1;
      border: 1px solid #fff; /* حدود الحقل بيضاء */
      background: #192842; /* خلفية الحقل نيلي */
      color: #fff; /* لون النص أبيض */
      border-radius: 5px;
      padding: 5px 10px;
      font-family: 'Cairo', sans-serif;
    }
    .search-bar-container input::placeholder {
      color: rgba(255, 255, 255, 0.7); /* لون نص الـ placeholder أبيض شفاف */
    }
    .search-bar-container .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      margin-right: 10px;
      cursor: pointer;
      color: #fff;
    }
  </style>
</head>
<body>

  <div class="search-bar-container" id="search-bar-container">
    <input type="text" id="search-input" placeholder="اكتب للبحث عن الأخبار...">
    <button class="close-btn" id="close-search-btn">&times;</button>
  </div>

  <div class="container top-buttons">
    <div class="btn-group" role="group" aria-label="News Sections">
      <a href="javascript:void(0)" class="btn btn-primary" data-section="محليات">محليات</a>
      <a href="javascript:void(0)" class="btn btn-primary" data-section="المنتخبات الوطنية">المنتخبات الوطنية</a>
      <a href="javascript:void(0)" class="btn btn-primary" data-section="دوري نجوم العراق">دوري نجوم العراق</a>
      <a href="javascript:void(0)" class="btn btn-primary" data-section="عالمي">عالمي</a>
    </div>
  </div>

  <div class="container news-container">
    <div class="row" id="news-container">
      <div class="col-12 text-center my-5" id="loading-message">
        <div class="loading-spinner">
          <div class="spinner-border" role="status"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="go:telegram" class="footer-btn">
      <img src="https://hussam9595.github.io/Pronews/telegram-brands-solid-full.svg" alt="Telegram">
      <span>تلغرام</span>
    </a>
    <a href="go:youtube" class="footer-btn">
      <img src="https://hussam9595.github.io/Pronews/youtube-brands-solid-full.svg" alt="YouTube">
      <span>يوتيوب</span>
    </a>
    <a href="go:HOME" class="footer-btn">
      <img src="https://hussam9595.github.io/Pronews/tv-solid-full.svg" alt="TV">
      <span>تلفاز</span>
    </a>
    <a href="go:VOD" class="footer-btn">
      <img src="https://hussam9595.github.io/Pronews/circle-play-solid-full.svg" alt="VOD">
      <span>VOD</span>
    </a>
    <a href="javascript:void(0)" class="footer-btn" id="search-btn">
      <i class="fas fa-search"></i>
      <span>بحث</span>
    </a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const baseUrl = "https://www.footballgallery.net";
    const proxy = "https://api.allorigins.win/get?url=";
    const container = document.getElementById("news-container");
    const searchBarContainer = document.getElementById("search-bar-container");
    const searchInput = document.getElementById("search-input");
    const searchButton = document.getElementById("search-btn");
    const closeSearchButton = document.getElementById("close-search-btn");
    
    let allNewsData = [];
    let currentSection = new URLSearchParams(window.location.search).get('section') || 'محليات';

    const sectionUrls = {
      'المنتخبات الوطنية': '/ar/section/%D8%A7%D9%84%D9%85%D9%86%D8%AA%D8%AE%D8%A8%D8%A7%D8%AA-%D8%A7%D9%84%D9%88%D8%B7%D9%86%D9%8A%D8%A9',
      'دوري نجوم العراق': '/ar/section/%D8%AF%D9%88%D8%B1%D9%8A-%D9%86%D8%AC%D9%88%D9%85-%D8%A7%D9%84%D8%B9%D8%B1%D8%A7%D9%82',
      'محليات': '/ar/section/%D9%85%D8%AD%D9%84%D9%8A%D8%A7%D8%AA',
      'عالمي': '/ar/section/%D8%B9%D8%A7%D9%84%D9%85%D9%8A',
    };

    document.querySelectorAll('.top-buttons .btn-group .btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const section = event.target.dataset.section;
            currentSection = section;
            history.pushState(null, '', `index.html?section=${section}`);
            loadNews(section);
        });
    });

    searchButton.addEventListener('click', () => {
        searchBarContainer.classList.add('active');
        searchInput.focus();
        document.querySelector('.top-buttons').style.display = 'none';
        renderNews(allNewsData);
    });

    closeSearchButton.addEventListener('click', () => {
        searchBarContainer.classList.remove('active');
        searchInput.value = '';
        document.querySelector('.top-buttons').style.display = 'flex';
        renderNews(allNewsData);
    });

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim().toLowerCase();
        if (query.length > 0) {
            const filteredNews = allNewsData.filter(item => item.title.toLowerCase().includes(query));
            renderNews(filteredNews);
        } else {
            renderNews(allNewsData);
        }
    });

    function displayErrorAndRetry() {
        container.innerHTML = `
            <div class='col-12 text-center error-message'>
                ❌ الإنترنت ضعيف
                <div>
                    <button class="retry-button" onclick="loadNews(currentSection)">إعادة المحاولة</button>
                </div>
            </div>`;
    }

    function renderNews(newsItems) {
      container.innerHTML = "";
      if (newsItems.length === 0) {
        container.innerHTML = "<div class='col-12 text-center text-muted'>⚠️ لا توجد أخبار مطابقة.</div>";
        return;
      }
      newsItems.forEach(item => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'col-md-6 col-lg-4 mb-4';
        cardDiv.innerHTML = `
            <div class="card h-100" style="cursor: pointer;" onclick="openNews('${encodeURIComponent(item.link)}')">
                <div class="image-placeholder">PRO TV</div>
                <img src="" class="card-img-top" alt="${item.title}">
                <div class="card-body">
                    <h5 class="card-title">${item.title}</h5>
                    <p class="card-text"><small>${item.date}</small></p>
                </div>
            </div>
        `;
        container.appendChild(cardDiv);
        
        const imgElement = cardDiv.querySelector('.card-img-top');
        const placeholderElement = cardDiv.querySelector('.image-placeholder');
        if (item.imgSrc) {
            loadImageWithRetry(imgElement, placeholderElement, item.imgSrc);
        } else {
            placeholderElement.style.display = 'flex';
        }
      });
    }

    function loadNews(section) {
        container.innerHTML = `<div class="col-12 text-center my-5" id="loading-message">
            <div class="loading-spinner">
            <div class="spinner-border" role="status"></div>
            </div>
        </div>`;

        document.querySelectorAll('.top-buttons .btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.section === section) {
                btn.classList.add('active');
            }
        });

        const targetUrl = baseUrl + sectionUrls[section];

        fetch(proxy + encodeURIComponent(targetUrl))
            .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.json();
            })
            .then(data => {
                const doc = new DOMParser().parseFromString(data.contents, "text/html");
                const items = doc.querySelectorAll(".news-initial-box");
                
                if (items.length === 0) {
                    container.innerHTML = "<div class='col-12 text-center text-muted'>⚠️ لا توجد أخبار في هذا القسم.</div>";
                    return;
                }

                const fetchPromises = Array.from(items).map(async (box) => {
                    const anchor = box.querySelector("a.list-item-wrapper");
                    const title = box.querySelector("h3")?.textContent.trim() || "بدون عنوان";
                    const date = box.querySelector(".dates-sec span")?.textContent.trim() || "";
                    const link = anchor ? new URL(anchor.getAttribute("href"), baseUrl).href : "#";

                    let finalImgSrc = '';
                    if (link !== '#') {
                        try {
                            const newsRes = await fetch(proxy + encodeURIComponent(link));
                            if (!newsRes.ok) throw new Error('فشل جلب تفاصيل الخبر');
                            const newsData = await newsRes.json();
                            const newsDoc = new DOMParser().parseFromString(newsData.contents, "text/html");
                            const ogImageMeta = newsDoc.querySelector("meta[property='og:image']");
                            if (ogImageMeta) {
                                finalImgSrc = ogImageMeta.getAttribute('content');
                            }
                        } catch (err) {
                            console.error(`Error fetching og:image for ${link}:`, err);
                            finalImgSrc = '';
                        }
                    }
                    return { title, date, link, imgSrc: finalImgSrc || '' };
                });

                Promise.all(fetchPromises)
                    .then(results => {
                        allNewsData = results;
                        renderNews(allNewsData);
                    })
                    .catch(err => {
                        console.error("Error during image fetching:", err);
                        displayErrorAndRetry();
                    });
            })
            .catch(err => {
                console.error("Error fetching news list:", err);
                displayErrorAndRetry();
            });
    }

    const loadImageWithRetry = (imgElement, placeholderElement, url, maxRetries = 5, attempt = 0) => {
      if (attempt >= maxRetries) {
          return;
      }
      const tempImg = new Image();
      tempImg.src = `${url}?v=${Date.now()}`;
      tempImg.onload = () => {
          if (tempImg.naturalWidth > 0) {
              imgElement.src = tempImg.src;
              imgElement.classList.add('loaded');
              placeholderElement.style.display = 'none';
          } else {
              setTimeout(() => loadImageWithRetry(imgElement, placeholderElement, url, maxRetries, attempt + 1), 1000);
          }
      };
      tempImg.onerror = () => {
          setTimeout(() => loadImageWithRetry(imgElement, placeholderElement, url, maxRetries, attempt + 1), 1000);
      };
    };

    loadNews(currentSection);

    function openNews(url) {
      window.location.href = "news-detail.html?link=" + url;
    }
  </script>
</body>
</html>
